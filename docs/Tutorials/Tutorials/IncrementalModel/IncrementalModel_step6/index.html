<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title># 6. Multi-Level · Test Site</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;h1&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;6-multi-level&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#6-multi-level&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;6. Multi-Level&lt;/h1&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="# 6. Multi-Level · Test Site"/><meta property="og:type" content="website"/><meta property="og:url" content="https://roiarthurb.github.io/BC2019-Gama-Site/"/><meta property="og:description" content="&lt;h1&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;6-multi-level&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#6-multi-level&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;6. Multi-Level&lt;/h1&gt;
"/><meta property="og:image" content="https://roiarthurb.github.io/BC2019-Gama-Site/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://roiarthurb.github.io/BC2019-Gama-Site/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/BC2019-Gama-Site/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://roiarthurb.github.io/BC2019-Gama-Site/blog/atom.xml" title="Test Site Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://roiarthurb.github.io/BC2019-Gama-Site/blog/feed.xml" title="Test Site Blog RSS Feed"/><link rel="stylesheet" href="/css/code-block-buttons.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><link rel="stylesheet" href="/BC2019-Gama-Site/css/main.css"/><script src="/BC2019-Gama-Site/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/BC2019-Gama-Site/"><img class="logo" src="/BC2019-Gama-Site/img/favicon.ico" alt="Test Site"/><h2 class="headerTitleWithLogo">Test Site</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/BC2019-Gama-Site/docs/doc1" target="_self">Docs</a></li><li class=""><a href="/BC2019-Gama-Site/help" target="_self">Help</a></li><li class=""><a href="/BC2019-Gama-Site/blog/" target="_self">Blog</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"># 6. Multi-Level</h1></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="6-multi-level"></a><a href="#6-multi-level" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6. Multi-Level</h1>
<p>This step Illustrates how to define a multi-level model</p>
<h2><a class="anchor" aria-hidden="true" id="formulation"></a><a href="#formulation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Formulation</h2>
<p>We propose to let the buildings manage what happens when the people are inside buildings. In this context, we will use the multi-level properties of GAMA: when a people agent will be inside a building, it will be captured by it and its species will be modified. It will be not anymore the people agent that will decide when to leave the building, but the building itself.</p>
<p>We will need to:</p>
<ul>
<li>define a micro-species of people inside the building species (<strong>people_in_buildings</strong>)</li>
<li>define a new variable for the building agent (_people_in<strong>building</strong>)</li>
<li>define two new behaviors for building: <strong>let_people_leave</strong> and <strong>let_people_enter</strong></li>
<li>modify the aspect of the building</li>
<li>modify some global variables for counting the number of infected people_</li>
</ul>
<p><img src="resources/images/tutorials/Incremental_model6.jpg" alt="images/Incremental_model6.jpg"></p>
<h2><a class="anchor" aria-hidden="true" id="model-definition"></a><a href="#model-definition" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Model Definition</h2>
<h3><a class="anchor" aria-hidden="true" id="building"></a><a href="#building" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>building</h3>
<p>First, we define a new species called <strong>people_in_building</strong> inside the <strong>building</strong> species. Thus, a building could have agents of this species as <strong>members</strong> and control them. The <strong>people_in_building</strong> species has for parent the <strong>people</strong> species, which means that a <strong>people_in_building</strong> agent has all the properties, aspect and behaviors of a <strong>people</strong> agent.
In our case, we want the once a people agent inside a building, this people agent does nothing. Then, we use the <strong>schedules</strong> facet of the species to remove the <strong>people_in_building</strong> from the scheduler.</p>
<pre><code class="hljs">species building {
    ...
        species people_in_building parent: people schedules: [] {
    }
    ...
}
</code></pre>
<p>We define a new dynamic variable for building agent: <strong>people_inside</strong> that will correspond to the list of <strong>people_in_building</strong> agents inside the building. Note that we use the syntax <strong>-&gt; {...}</strong> to make the variable dynamic. However, instead of <strong>update</strong> that allows a variable to be recomputed at each simulation step, the syntax <strong>-&gt; {...}</strong> allows the variable to be recomputed each time it is called (and thus avoid outdated problems). To compute this variable, we use the <strong>members</strong> built-in variable that corresponds to the list of micro-agents captured by the macro-agent.</p>
<pre><code class="hljs">species building {
    <span class="hljs-params">...</span>
        <span class="hljs-built_in">list</span>&lt;people_in_building&gt; people_inside -&gt; {members collect people_in_building(each)};
    <span class="hljs-params">...</span>
}
</code></pre>
<p>We define a first reflex for the buildings that will be activated at each simulation step and that will allow the building to capture all the people that are inside its geometry and that are not moving (target = nil). Capturing agents means putting them inside its <strong>members</strong> list and changing their species: here the <strong>people</strong> agents become <strong>people_in_building</strong> agents.</p>
<pre><code class="hljs">species building {
    <span class="hljs-params">...</span>
      reflex let_people_enter {
        <span class="hljs-built_in">list</span>&lt;people&gt; entering_people &lt;- people inside <span class="hljs-built_in">self</span> <span class="hljs-keyword">where</span> (each.target = nil);
        <span class="hljs-keyword">if</span> <span class="hljs-literal">not</span> (empty (entering_people)) {
            capture entering_people as: people_in_building ;
        }
    }
        <span class="hljs-params">...</span>.
}
</code></pre>
<p>We define a second reflex for the buildings that will be activated at each simulation step and that will allow the building to release some of the <strong>people_in_building</strong> agents. First, it increments the staying counter of all the <strong>people_in_building</strong> agents. Then it builds the list of leaving people by testing the same probability as before for all the <strong>people_in_building</strong> agents. Finally, if this list is not empty, it releases them as people agents (and gives them a new target point).</p>
<pre><code class="hljs">species building {<span class="hljs-operator">
    ...
       </span>reflex let_people_leave  {
        ask members <span class="hljs-keyword">as</span>: people_in_building{
            staying_counter &lt;- staying_counter + <span class="hljs-number">1</span>;
        }
        <span class="hljs-built_in">list</span>&lt;people_in_building&gt; leaving_people &lt;- <span class="hljs-built_in">list</span>&lt;people_in_building&gt;(members where (flip(people<span class="hljs-constructor">_in_building(<span class="hljs-params">each</span>)</span>.staying_counter<span class="hljs-operator"> / </span>staying_coeff)));
        <span class="hljs-keyword">if</span> not (empty (leaving_people)) {
            release leaving_people <span class="hljs-keyword">as</span>: people <span class="hljs-keyword">in</span>: world returns: released_people;
            ask released_people {
                target &lt;- any_location_in (one<span class="hljs-constructor">_of(<span class="hljs-params">building</span>)</span>);
            }
        }
    }
        ....
}
</code></pre>
<p>At last, we refine the aspect of the buildings: if there is not people inside the building, we draw it with gray color. If the number of <strong>people_in_building</strong> infected is higher than the number of <strong>people_in_building</strong> not infected, we draw it in red; otherwise in green.</p>
<pre><code class="hljs">species building {
    ...
        aspect geom {
        <span class="hljs-built_in">int</span> nbI &lt;- members count people_in_building(each).is_infected;
        <span class="hljs-built_in">int</span> nbT &lt;- length(members);
        <span class="hljs-title">draw</span> <span class="hljs-built_in">shape</span> <span class="hljs-built_in">color</span>:nbT = <span class="hljs-number">0</span> ? #gray : (<span class="hljs-built_in">float</span>(nbI)/nbT &gt; <span class="hljs-number">0.5</span> ? #<span class="hljs-built_in">red</span> : #<span class="hljs-built_in">green</span>) depth: <span class="hljs-built_in">height</span>;
    }
}
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="global-variables"></a><a href="#global-variables" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>global variables</h3>
<p>In order to take into account the people that are inside the buildings for the computation of <strong>nb_people_infected</strong>, we first build the list of <strong>people_in_building</strong>. As <strong>people_in_building</strong> is a macro species of <strong>building</strong>, we cannot compute it directly like for the other species, we then aggregate all the list <strong>people_inside</strong> of all building in a single list (<strong>list_people_in_buildings</strong>). Then, we compute the number of infected people as the number of people infected outside the building + the number of people infected inside them.</p>
<pre><code class="hljs">global  {
    ...
    list&lt;people_in_building&gt; list_people_in_buildings <span class="hljs-keyword">update</span>: (building accumulate <span class="hljs-keyword">each</span>.people_inside) <span class="hljs-keyword">where</span> (<span class="hljs-keyword">not</span> dead(<span class="hljs-keyword">each</span>));
    int nb_people_infected &lt;- nb_infected_init <span class="hljs-keyword">update</span>: people <span class="hljs-built_in">count</span> (<span class="hljs-keyword">each</span>.is_infected) + (empty(list_people_in_buildings) ? <span class="hljs-number">0</span> : list_people_in_buildings <span class="hljs-built_in">count</span> (<span class="hljs-keyword">each</span>.is_infected));
        ...
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="complete-model"></a><a href="#complete-model" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Complete Model</h2>
<pre><code class="hljs"> 
<span class="hljs-keyword">global</span>  {
    <span class="hljs-type">int</span> nb_people &lt;- <span class="hljs-number">500</span>;
    <span class="hljs-type">float</span> step &lt;- <span class="hljs-number">1</span> #minutes;
    <span class="hljs-type">float</span> infection_distance &lt;- <span class="hljs-number">2.0</span> #m;
    <span class="hljs-type">float</span> proba_infection &lt;- <span class="hljs-number">0.05</span>;
    <span class="hljs-type">int</span> nb_infected_init &lt;- <span class="hljs-number">5</span>;
    file roads_shapefile &lt;- file("../includes/road.shp");
    file buildings_shapefile &lt;- file("../includes/building.shp");
    geometry shape &lt;- envelope(roads_shapefile);
    graph road_network;
    <span class="hljs-type">int</span> current_hour <span class="hljs-keyword">update</span>: (<span class="hljs-keyword">cycle</span> / <span class="hljs-number">60</span>) mod <span class="hljs-number">24</span>;
    <span class="hljs-type">float</span> staying_coeff <span class="hljs-keyword">update</span>: <span class="hljs-number">10.0</span> ^ (<span class="hljs-number">1</span> + min([abs(current_hour - <span class="hljs-number">9</span>), abs(current_hour - <span class="hljs-number">12</span>), abs(current_hour - <span class="hljs-number">18</span>)]));
    
    list&lt;people_in_building&gt; list_people_in_buildings <span class="hljs-keyword">update</span>: (building accumulate <span class="hljs-keyword">each</span>.people_inside) <span class="hljs-keyword">where</span> (<span class="hljs-keyword">not</span> dead(<span class="hljs-keyword">each</span>));
    <span class="hljs-type">int</span> nb_people_infected &lt;- nb_infected_init <span class="hljs-keyword">update</span>: people count (<span class="hljs-keyword">each</span>.is_infected) + (empty(list_people_in_buildings) ? <span class="hljs-number">0</span> : list_people_in_buildings count (<span class="hljs-keyword">each</span>.is_infected));
    
    <span class="hljs-type">int</span> nb_people_not_infected &lt;- nb_people - nb_infected_init <span class="hljs-keyword">update</span>: nb_people - nb_people_infected;
    <span class="hljs-type">bool</span> is_night &lt;- <span class="hljs-keyword">true</span> <span class="hljs-keyword">update</span>: current_hour &lt; <span class="hljs-number">7</span> <span class="hljs-keyword">or</span> current_hour &gt; <span class="hljs-number">20</span>;
    
    <span class="hljs-type">float</span> infected_rate <span class="hljs-keyword">update</span>: nb_people_infected/nb_people;
    init {
        <span class="hljs-keyword">create</span> road <span class="hljs-keyword">from</span>: roads_shapefile;
        road_network &lt;- as_edge_graph(road);
        <span class="hljs-keyword">create</span> building <span class="hljs-keyword">from</span>: buildings_shapefile;
        <span class="hljs-keyword">create</span> people number:nb_people {
            speed &lt;- <span class="hljs-number">5.0</span> #km/#h;
            building bd &lt;- one_of(building);
            <span class="hljs-keyword">location</span> &lt;- any_location_in(bd);
        }
        ask nb_infected_init among people {
            is_infected &lt;- <span class="hljs-keyword">true</span>;
        }
        
    }
    reflex end_simulation <span class="hljs-keyword">when</span>: infected_rate = <span class="hljs-number">1.0</span> {       
        <span class="hljs-keyword">do</span> halt;
    }
}

species people skills:[moving]{     
    <span class="hljs-type">bool</span> is_infected &lt;- <span class="hljs-keyword">false</span>;
    <span class="hljs-type">point</span> target;
    <span class="hljs-type">int</span> staying_counter;
        
    reflex <span class="hljs-keyword">move</span> <span class="hljs-keyword">when</span>: target != nil{
        <span class="hljs-keyword">do</span> goto target:target <span class="hljs-keyword">on</span>: road_network;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">location</span> = target) {
            target &lt;- any_location_in (one_of(building));
            target &lt;- nil;
            staying_counter &lt;- <span class="hljs-number">0</span>;
        } 
    }
    reflex infect <span class="hljs-keyword">when</span>: is_infected{
        ask people at_distance infection_distance {
            <span class="hljs-keyword">if</span> flip(proba_infection) {
                is_infected &lt;- <span class="hljs-keyword">true</span>;
            }
        }
    }
    aspect <span class="hljs-type">circle</span>{
        draw circle(<span class="hljs-number">5</span>) color:is_infected ? #red : #green;
    }
    aspect sphere3D{
        draw sphere(<span class="hljs-number">3</span>) at: {<span class="hljs-keyword">location</span>.x,<span class="hljs-keyword">location</span>.y,<span class="hljs-keyword">location</span>.z + <span class="hljs-number">3</span>} color:is_infected ? #red : #green;
    }
}

species road {
    geometry display_shape &lt;- shape + <span class="hljs-number">2.0</span>;
    aspect geom {
        draw display_shape color: #black depth: <span class="hljs-number">3.0</span>;
    }
}

species building {
    <span class="hljs-type">float</span> height &lt;- <span class="hljs-number">10</span>#m + rnd(<span class="hljs-number">10</span>) #m;
    list&lt;people_in_building&gt; people_inside -&gt; {members collect people_in_building(<span class="hljs-keyword">each</span>)};
    
    aspect geom {
        <span class="hljs-type">int</span> nbI &lt;- members count people_in_building(<span class="hljs-keyword">each</span>).is_infected;
        <span class="hljs-type">int</span> nbT &lt;- length(members);
        draw shape color:nbT = <span class="hljs-number">0</span> ? #gray : (<span class="hljs-type">float</span>(nbI)/nbT &gt; <span class="hljs-number">0.5</span> ? #red : #green) depth: height;
    }
    
    species people_in_building parent: people schedules: [] {
        aspect <span class="hljs-type">circle</span>{}
        aspect sphere3D{}
    }
    
    species people_in_2 parent: people schedules: [] {
        aspect <span class="hljs-type">circle</span>{}
        aspect sphere3D{}
    }
    
    reflex let_people_leave  {
        ask members <span class="hljs-keyword">as</span>: people_in_building{
            staying_counter &lt;- staying_counter + <span class="hljs-number">1</span>;
        }
        list&lt;people_in_building&gt; leaving_people &lt;- list&lt;people_in_building&gt;(members <span class="hljs-keyword">where</span> (flip(people_in_building(<span class="hljs-keyword">each</span>).staying_counter / staying_coeff)));
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (empty (leaving_people)) {
            <span class="hljs-keyword">release</span> leaving_people <span class="hljs-keyword">as</span>: people <span class="hljs-keyword">in</span>: world <span class="hljs-keyword">returns</span>: released_people;
            ask released_people {
                target &lt;- any_location_in (one_of(building));
            }
        }
    }
    reflex let_people_enter {
        list&lt;people&gt; entering_people &lt;- people inside self <span class="hljs-keyword">where</span> (<span class="hljs-keyword">each</span>.target = nil);
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (empty (entering_people)) {
            capture entering_people <span class="hljs-keyword">as</span>: people_in_building ;
        }
    }
}

experiment main_experiment <span class="hljs-keyword">type</span>:gui{
    parameter "Infection distance" var: infection_distance;
    parameter "Proba infection" var: proba_infection min: <span class="hljs-number">0.0</span> max: <span class="hljs-number">1.0</span>;
    parameter "Nb people infected at init" var: nb_infected_init ;
    output {
        monitor "Current hour" <span class="hljs-keyword">value</span>: current_hour;
        monitor "Infected people rate" <span class="hljs-keyword">value</span>: infected_rate;
        display map_3D <span class="hljs-keyword">type</span>: opengl {
            light <span class="hljs-number">1</span> color:(is_night ? <span class="hljs-number">50</span> : <span class="hljs-number">255</span>);
            image "../includes/soil.jpg";
            species road aspect:geom;
            species people aspect:sphere3D;         
            species building aspect:geom transparency: <span class="hljs-number">0.5</span>;
        }
        display chart <span class="hljs-keyword">refresh</span>:every(<span class="hljs-number">10</span>) {
            chart "Disease spreading" <span class="hljs-keyword">type</span>: series {
                data "susceptible" <span class="hljs-keyword">value</span>: nb_people_not_infected color: #green;
                data "infected" <span class="hljs-keyword">value</span>: nb_people_infected color: #red;
            }
        }
    }
}
</code></pre>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#formulation">Formulation</a></li><li><a href="#model-definition">Model Definition</a><ul class="toc-headings"><li><a href="#building">building</a></li><li><a href="#global-variables">global variables</a></li></ul></li><li><a href="#complete-model">Complete Model</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/BC2019-Gama-Site/" class="nav-home"><img src="/BC2019-Gama-Site/img/favicon.ico" alt="Test Site" width="66" height="58"/></a><div><h5>Docs</h5><a href="/BC2019-Gama-Site/docs/en/doc1.html">Getting Started (or other categories)</a><a href="/BC2019-Gama-Site/docs/en/doc2.html">Guides (or other categories)</a><a href="/BC2019-Gama-Site/docs/en/doc3.html">API Reference (or other categories)</a></div><div><h5>Community</h5><a href="/BC2019-Gama-Site/en/users.html">User Showcase</a><a href="http://stackoverflow.com/questions/tagged/" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://discordapp.com/">Project Chat</a><a href="https://twitter.com/" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/BC2019-Gama-Site/blog">Blog</a><a href="https://github.com/">GitHub</a><a class="github-button" data-icon="octicon-star" data-count-href="/facebook/docusaurus/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><a href="https://opensource.facebook.com/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/BC2019-Gama-Site/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2019 GAMA-Platform</section></footer></div></body></html>